(()=>{"use strict";const e=window.wc.blocksCheckout,t=window.React,a=window.wp.element,i=window.wp.data,o=window.wp.components,p=window.wp.i18n,s=wcSettings["posti-blocks_data"].txt,n=((0,p.__)("Block options","woo-pakettikauppa"),(0,p.__)("Pickup point","woo-pakettikauppa"),(0,p.__)("Select a pickup point","woo-pakettikauppa"),(0,p.__)("No pickup point: Send to the street address","woo-pakettikauppa"),(0,p.__)("Other","woo-pakettikauppa"),(0,p.__)("Please choose a pickup point","woo-pakettikauppa"),(0,p.__)("No pickup points were found. Check the address.","woo-pakettikauppa"),(0,p.__)("You can choose the pickup point on the Checkout page","woo-pakettikauppa"),(0,p.__)("Choose one of pickup points close to the address you entered","woo-pakettikauppa"),(0,p.__)("Custom pickup address","woo-pakettikauppa"),(0,p.__)("If none of your preferred pickup points are listed, fill in a custom address above and select another pickup point","woo-pakettikauppa"),(0,p.__)("After entering, please wait for a while for the results to be received","woo-pakettikauppa"),(0,p.__)("The value is too short","woo-pakettikauppa"),(0,p.__)("Invalid character entered","woo-pakettikauppa"),(0,p.__)("The selection of pickup points has been changed based on the address %s","woo-pakettikauppa"),"Posti"),c=()=>wcSettings&&wcSettings["posti-blocks_data"]?wcSettings["posti-blocks_data"]:[],l=e=>{let t=c();if("methods"in t)for(let a=0;a<t.methods.length;a++)if(t.methods[a].instance_id==e&&t.methods[a].pickup_required)return!0;return!1},r=(e,t)=>JSON.stringify(e)===JSON.stringify(t),u=(e,t)=>{const[i,o]=(0,a.useState)(e);return(0,a.useEffect)((()=>{const a=setTimeout((()=>{o(e)}),t);return()=>{clearTimeout(a)}}),[e,t]),i},d=e=>!/[`!@#$%^*_+=\[\]{};:|<>\/?~]/.test(e),_=JSON.parse('{"apiVersion":2,"name":"pakettikauppa/pickup-point-selection-checkout","version":"1.0.1","title":"Posti pickup point selection","category":"woocommerce","description":"Allow to add components for Pakettikauppa shipping method on Checkout page","parent":["woocommerce/checkout-shipping-methods-block"],"supports":{"html":false,"align":false,"multiple":false,"reusable":false},"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}},"text":{"type":"string","default":""}},"textdomain":"woo-pakettikauppa"}');(0,e.registerCheckoutBlock)({metadata:_,component:({checkoutExtensionData:e,extension:p})=>{const{setExtensionData:_}=e,[k,h]=(0,a.useState)([]),[m,f]=(0,a.useState)({data_loaded:!1,rate:null,destination:null,method:null,update_list:"main",pickup_points:{list:[],type:"",selected:""},custom_address:"",show_block:!1,show_custom:!1}),[g,w]=(0,a.useState)([]),b="posti_pickup_point_error",[E,v]=(0,a.useState)(""),y=u(E,2e3),[S,C]=(0,a.useState)(""),[x,j]=(0,a.useState)(""),{setValidationErrors:F,clearValidationError:N}=(0,i.useDispatch)("wc/store/validation"),T=(0,i.useSelect)((e=>e("wc/store/validation").getValidationError(b))),{shippingRates:O,shippingAddress:D}=(0,i.useSelect)((e=>{const t=e("wc/store/cart");return{shippingRates:t.getCartData().shippingRates,shippingAddress:t.getCartData().shippingAddress}})),P=u(D,1500);function R(...e){console.log("["+n+" warning]",...e)}const A=(0,a.useCallback)((()=>m.method&&m.destination),[m.method,m.destination]);return(0,a.useEffect)((()=>{A()&&f({...m,data_loaded:!0})}),[A]),(0,a.useEffect)((()=>{O.length&&h((e=>{if(!e.length)return[];let t=[];for(let a=0;a<e.length;a++)if(e[a].shipping_rates)for(let i=0;i<e[a].shipping_rates.length;i++)e[a].shipping_rates[i].rate_id&&t.push(e[a].shipping_rates[i]);return t})(O))}),[O]),(0,a.useEffect)((()=>{if(!D.country)return;let e={country:D.country,address:D?.address_1||"",city:D?.city||"",postcode:D?.postcode||""};r(m.destination,e)||f({...m,destination:e,data_loaded:!1})}),[P]),(0,a.useEffect)((()=>{if(k.length)for(let e=0;e<k.length;e++)!k[e].selected||m.rate&&m.rate.id==k[e].rate_id||f({...m,rate:{id:k[e].rate_id,method:k[e].method_id,instance:k[e].instance_id},data_loaded:!1})}),[k]),(0,a.useEffect)((()=>{if(!m.rate)return;let e=!1,t=(e=>{let t=c();if("methods"in t)for(let a=0;a<t.methods.length;a++)if(t.methods[a].instance_id==e)return t.methods[a];return null})(m.rate.instance);r(t,m.method)||(""!==m.rate.id&&null!==t&&m.rate.instance&&t.have_pickups&&(e=!0),f({...m,method:t,show_block:e,update_list:"main"}))}),[m.rate]),(0,a.useEffect)((()=>{m.data_loaded&&"main"==m.update_list&&(m.method?.service?((e,t,a=null)=>{let i=c();return"ajax_url"in i?fetch(`${i.ajax_url}?action=pakettikauppa_get_pickup_points`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:e,destination:t})}).then((e=>e.json())).catch((e=>(console.error("Error fetching pickup points:",e),[]))):(console.error("Failed to get ajax URL"),[])})(m.method.service,m.destination).then((e=>{let t=[];e.success?e.data?t=e.data:R("Failed to get pickup points:","Data parameter not received"):R("Failed to get pickup points:",e.data),r(t,m.pickup_points.list)||f({...m,pickup_points:{...m.pickup_points,list:t,type:c().list_type},show_custom:c().allow_custom_address})})):R("Failed to update pickup points:","Method data is empty"))}),[m.update_list,m.data_loaded]),(0,a.useEffect)((()=>{m.data_loaded&&"custom"==m.update_list&&m.custom_address&&(m.method?.service?((e,t,a=null)=>{let i=c();return"ajax_url"in i?fetch(`${i.ajax_url}?action=pakettikauppa_get_custom_pickup_points`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({service:e,address:t})}).then((e=>e.json())).catch((e=>(console.error("Error fetching pickup points:",e),[]))):(console.error("Failed to get ajax URL"),[])})(m.method.service,m.custom_address).then((e=>{let t=[];e.success?e.data?t=e.data:R("Failed to get pickup points by custom address:","Data parameter not received"):R("Failed to get pickup points by custom address:",e.data),f({...m,pickup_points:{...m.pickup_points,list:t}})})):R("Failed to update pickup points by custom address:","Method data is empty"))}),[m.data_loaded,m.update_list]),(0,a.useEffect)((()=>{m.method&&(E.length?E.length<3||!d(E)||f({...m,update_list:"custom",custom_address:E}):f({...m,update_list:"main",custom_address:""}))}),[y]),(0,a.useEffect)((()=>{E.length>0&&E.length<3?C(s.custom_pickup_error_too_short):d(E)?C(""):C(s.custom_pickup_error_bad_char)}),[E]),(0,a.useEffect)((()=>{if(!m.data_loaded)return;let e=[],t="";if("menu"===m.pickup_points.type&&(t="- "+s.pickup_select_field_default+" -"),l(m.rate.instance)||(t="- "+s.pickup_select_field_optional+" -"),""!==t&&e.push({label:t,value:""}),m.pickup_points.list?.length)for(let t=0;t<m.pickup_points.list.length;t++){let a=m.pickup_points.list[t];e.push({label:a.name+" ("+a.street_address+")",value:a.provider+": "+a.name+" (#"+a.pickup_point_id+")"})}m.show_custom&&e.push({label:s.pickup_select_other,value:"other"}),w(e)}),[m.pickup_points?.list]),(0,a.useEffect)((()=>{T&&(N(b),j("")),m.rate?.instance&&(e=>{let t=c();if("methods"in t)for(let a=0;a<t.methods.length;a++)if(t.methods[a].instance_id==e&&t.methods[a].have_pickups)return!0;return!1})(m.rate.instance)&&l(m.rate.instance)&&(_("wc-pakettikauppa","pakettikauppa_pickup_point",m.pickup_points.selected),""===m.pickup_points.selected&&(F({[b]:{message:s.pickup_error,hidden:!1}}),j("error")))}),[_,m.rate?.id,m.pickup_points?.selected]),(0,a.useEffect)((()=>{}),[m]),m.show_block?(0,t.createElement)("div",{className:`pakettikauppa-block pakettikauppa-shipping-pickup-point ${x}`},m.pickup_points.list?.length?(0,t.createElement)(t.Fragment,null,"list"===m.pickup_points.type?(0,t.createElement)(o.RadioControl,{label:s.pickup_block_title,help:s.checkout_pickup_info,selected:m.pickup_points.selected,options:g,onChange:e=>f({...m,pickup_points:{...m.pickup_points,selected:e}})}):(0,t.createElement)(o.SelectControl,{id:"pakettikauppa_pickup_point",label:s.pickup_block_title,help:s.checkout_pickup_info,value:m.pickup_points.selected,options:g,onChange:e=>f({...m,pickup_points:{...m.pickup_points,selected:e}})})):(0,t.createElement)(o.BaseControl,{label:s.pickup_block_title},(0,t.createElement)("p",null,s.pickup_not_found)),T?.hidden||""!==m.pickup_points.selected?null:(0,t.createElement)("div",{className:"wc-block-components-validation-error"},(0,t.createElement)("span",null,T?.message)),m.custom_address?(0,t.createElement)("p",{className:"pakettikauppa-custom-text"},s.custom_pickup_address.replaceAll("%s",'"'+m.custom_address+'"')):null,!m.show_custom||"other"!==m.pickup_points.selected&&m.pickup_points.list?.length?null:(0,t.createElement)(t.Fragment,null,(0,t.createElement)(o.TextareaControl,{label:s.custom_pickup_title,help:s.custom_pickup_description+". "+s.custom_pickup_help+".",value:E,onChange:e=>v(e)}),""===S?null:(0,t.createElement)("div",{className:"wc-block-components-validation-error"},(0,t.createElement)("span",null,S)))):(0,t.createElement)(t.Fragment,null)}})})();